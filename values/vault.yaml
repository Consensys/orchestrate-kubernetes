templates:
- |
  apiVersion: "vault.banzaicloud.com/v1alpha1"
  kind: "Vault"
  metadata:
    name: "vault"
  spec:
    size: 1
    image: vault:1.3.1
    bankVaultsImage: banzaicloud/bank-vaults:latest

    # Common annotations for all created resources
    annotations:
      common/annotation: "true"

    # Vault Pods , Services and TLS Secret annotations
    vaultAnnotations:
      type/instance: "vault"

    # Vault Configurer Pods and Services annotations
    vaultConfigurerAnnotations:
      type/instance: "vaultconfigurer"

    # Vault Pods , Services and TLS Secret labels
    vaultLabels:
      example.com/log-format: "json"

    # Vault Configurer Pods and Services labels
    vaultConfigurerLabels:
      example.com/log-format: "string"

    # Specify the ServiceAccount where the Vault Pod and the Bank-Vaults configurer/unsealer is running
    serviceAccount: vault

    # Specify the Service's type where the Vault Service is exposed
    # Please note that some Ingress controllers like https://github.com/kubernetes/ingress-gce
    # forces you to expose your Service on a NodePort
    serviceType: ClusterIP

    # Request an Ingress controller with the default configuration
    ingress:
      # Specify Ingress object annotations here, if TLS is enabled (which is by default)
      # the operator will add NGINX, Traefik and HAProxy Ingress compatible annotations
      # to support TLS backends
      annotations:
      # Override the default Ingress specification here
      # This follows the same format as the standard Kubernetes Ingress
      # See: https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.13/#ingressspec-v1beta1-extensions
      spec: {}

    # Use local disk to store Vault file data, see config section.
    volumes:
      - name: vault-file
        persistentVolumeClaim:
          claimName: vault-file

    volumeMounts:
      - name: vault-file
        mountPath: /vault/file

    # Support for distributing the generated CA certificate Secret to other namespaces.
    # Define a list of namespaces or use ["*"] for all namespaces.
    caNamespaces:
      - "*"

    # Describe where you would like to store the Vault unseal keys and root token.
    unsealConfig:
      options:
        # The preFlightChecks flag enables unseal and root token storage tests
        # This is true by default
        preFlightChecks: true
      kubernetes:
        secretNamespace: {{ .Values.vault.namespace }}

    # A YAML representation of a final vault config file.
    # See https://www.vaultproject.io/docs/configuration/ for more information.
    config:
      storage:
        file:
          path: "${ .Env.VAULT_STORAGE_FILE }" # An example how Vault config environment interpolation can be used
      listener:
        tcp:
          address: "0.0.0.0:8200"
          # Uncommenting the following line and deleting tls_cert_file and tls_key_file disables TLS
          tls_disable: true
          #tls_cert_file: /vault/tls/server.crt
          #tls_key_file: /vault/tls/server.key
      telemetry:
        statsd_address: localhost:9125
      ui: true

    # See: https://github.com/banzaicloud/bank-vaults#example-external-vault-configuration for more details.
    externalConfig:
      policies:
        - name: allow_secrets
          rules: path "secret/*" {
            capabilities = ["create", "read", "update", "delete", "list"]
            }
        - name: tx_signer_demo
          rules: path "secret/data/{{ .Values.orchestrate.namespace }}/keys/*" {
            capabilities = ["create", "read", "update", "delete", "list"]
            }
      auth:
        - type: kubernetes
          roles:
            # Allow every pod in the default namespace to use the secret kv store
            - name: tx-signer
              bound_service_account_names: ["tx-signer", "vault-secrets-webhook", "vault"]
              bound_service_account_namespaces: ["{{ .Values.vaultOperator.namespace }}", "{{ .Values.vault.namespace }}", "{{ .Values.orchestrate.namespace }}"]
              policies: ["allow_secrets", "tx_signer_demo"]

      secrets:
        - path: secret
          type: kv
          description: General secrets.
          options:
            version: 2

    vaultEnvsConfig:
      - name: VAULT_LOG_LEVEL
        value: debug
      - name: VAULT_STORAGE_FILE
        value: "/vault/file"

    # Marks presence of Istio, which influences things like port namings
    istioEnabled: false
- |
  apiVersion: v1
  kind: PersistentVolumeClaim
  metadata:
    name: vault-file
  spec:
    # https://kubernetes.io/docs/concepts/storage/persistent-volumes/#class-1
    # storageClassName: ""
    accessModes:
      - ReadWriteOnce
    resources:
      requests:
        storage: 1Gi
- |
  kind: ServiceAccount
  apiVersion: v1
  metadata:
    name: vault
- |
  kind: Role
  apiVersion: rbac.authorization.k8s.io/v1
  metadata:
    name: vault-secrets
  rules:
    - apiGroups:
        - ""
      resources:
        - secrets
      verbs:
        - "*"
- |
  kind: RoleBinding
  apiVersion: rbac.authorization.k8s.io/v1
  metadata:
    name: vault-secrets
  roleRef:
    kind: Role
    name: vault-secrets
    apiGroup: rbac.authorization.k8s.io
  subjects:
    - kind: ServiceAccount
      name: vault
- |
  # This binding allows the deployed Vault instance to authenticate clients
  # through Kubernetes ServiceAccounts (if configured so).
  apiVersion: rbac.authorization.k8s.io/v1
  kind: ClusterRoleBinding
  metadata:
    name: vault-auth-delegator
  roleRef:
    apiGroup: rbac.authorization.k8s.io
    kind: ClusterRole
    name: system:auth-delegator
  subjects:
    - kind: ServiceAccount
      name: vault
      namespace: {{ .Values.vault.namespace }}
    - kind: ServiceAccount
      name: vault
      namespace: {{ .Values.orchestrate.namespace }}